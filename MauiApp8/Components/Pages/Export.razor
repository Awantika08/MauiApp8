@page "/export"
@inject MauiApp8.Services.JournalService JournalService
@inject MauiApp8.Services.PdfExportService PdfExportService

<div class="content-container" style="max-width: 900px;">
    
    <div class="text-center mb-5">
        <h1 class="fw-bold mb-2">Export Journal</h1>
        <p class="text-muted">Create a beautifully formatted PDF of your memories.</p>
    </div>

    @if (!string.IsNullOrWhiteSpace(Message))
    {
        <div class="alert @(IsError ? "alert-danger" : "alert-success") border-0 rounded-4 shadow-sm mb-4">
            <div class="d-flex align-items-center gap-3">
                <span class="oi @(IsError ? "oi-warning" : "oi-check") fs-4" aria-hidden="true"></span>
                <div style="white-space: pre-wrap;">@Message</div>
            </div>
        </div>
    }

    <div class="row g-4">
        <!-- Main Export Settings -->
        <div class="col-lg-7">
            <div class="card h-100 border-0 shadow-sm" style="overflow: hidden;">
                <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0">
                    <div class="d-flex align-items-center gap-2">
                        <span class="oi oi-calendar text-primary"></span>
                        <h5 class="fw-bold mb-0">Select Range</h5>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted fw-bold text-uppercase">From</label>
                            <input type="date" class="form-control form-control-lg bg-light border-0"
                                   @bind-value="StartDate" @bind-value:format="yyyy-MM-dd" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted fw-bold text-uppercase">To</label>
                            <input type="date" class="form-control form-control-lg bg-light border-0"
                                   @bind-value="EndDate" @bind-value:format="yyyy-MM-dd" />
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top">
                         <button class="btn btn-primary w-100 py-3 rounded-4 shadow-sm fw-bold fs-5" 
                                disabled="@IsBusy" @onclick="ExportPdf">
                            @if (IsBusy)
                            {
                                <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                                <span>Generating...</span>
                            }
                            else
                            {
                                <span class="oi oi-data-transfer-download me-2" aria-hidden="true"></span>
                                <span>Export PDF Now</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info / Preview Side -->
        <div class="col-lg-5">
            <div class="card h-100 border-0 shadow-sm bg-light">
                <div class="card-body p-4 d-flex flex-column justify-content-center">
                    <h6 class="fw-bold mb-3">What's Included?</h6>
                    
                    <ul class="list-unstyled d-flex flex-column gap-3 mb-0">
                        <li class="d-flex align-items-center gap-3">
                            <div class="bg-white p-2 rounded-circle shadow-sm text-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <span class="oi oi-book" style="font-size: 0.9rem;"></span>
                            </div>
                            <span class="text-muted">Full journal entries</span>
                        </li>
                        <li class="d-flex align-items-center gap-3">
                            <div class="bg-white p-2 rounded-circle shadow-sm text-success d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <span class="oi oi-heart" style="font-size: 0.9rem;"></span>
                            </div>
                            <span class="text-muted">Mood tracking analytics</span>
                        </li>
                         <li class="d-flex align-items-center gap-3">
                            <div class="bg-white p-2 rounded-circle shadow-sm text-info d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <span class="oi oi-tags" style="font-size: 0.9rem;"></span>
                            </div>
                            <span class="text-muted">Smart tags & metadata</span>
                        </li>
                    </ul>

                    <div class="mt-4 p-3 rounded-4 bg-white border border-opacity-10 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small fw-bold text-uppercase text-muted">Preview Range</span>
                        </div>
                         <div class="fw-bold text-dark">
                             @StartDate.ToString("MMM dd") - @EndDate.ToString("MMM dd, yyyy")
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    DateTime StartDate = DateTime.Today.AddDays(-30);
    DateTime EndDate = DateTime.Today;

    string? Message;
    bool IsBusy;
    bool IsError;

    async Task ExportPdf()
    {
        Message = null;
        IsError = false;

        if (EndDate < StartDate)
        {
            Message = "End date cannot be earlier than start date.";
            IsError = true;
            return;
        }

        try
        {
            IsBusy = true;
            // Short delay for UI 
            await Task.Delay(500);

            var entries = await JournalService.GetEntriesInRangeAsync(StartDate, EndDate);
            var bytes = PdfExportService.GenerateJournalPdf(entries, StartDate, EndDate);

            var fileName = $"MyJournal_{StartDate:MMM-dd}_to_{EndDate:MMM-dd-yyyy}.pdf";
            var path = Path.Combine(FileSystem.AppDataDirectory, fileName);
            await File.WriteAllBytesAsync(path, bytes);

            Message = $"Success! Your journal has been exported.";
            IsError = false;

            await Launcher.Default.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(path)
            });
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = $"Oops! Something went wrong:\n{ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }
}
