@inherits LayoutComponentBase
@implements IDisposable
@inject MauiApp8.Services.ThemeService ThemeService

<SecurityGuard />

<div class="app-shell">
    <aside class="app-sidebar">
        <div class="sidebar-brand">
            <div class="brand-mark">J</div>
            <div class="brand-text">
                <div class="brand-title">Journal</div>
                <div class="brand-subtitle">Write • Track • Reflect</div>
            </div>
        </div>

        <div class="sidebar-nav">
            <NavMenu />
        </div>

        <div class="sidebar-footer">
            <small class="text-muted">v1.0 • Your private space</small>
        </div>
    </aside>

    <div class="app-main">
        <header class="app-topbar">
            <div class="topbar-right">
                <button class="btn btn-outline-secondary btn-sm"
                        @onclick="ToggleTheme">
                    @(ThemeService.Current == "dark" ? "🌙 Dark" : "☀️ Light")
                </button>

                <a class="btn btn-outline-secondary btn-sm ms-2"
                   href="https://learn.microsoft.com/aspnet/core/" target="_blank">
                    About
                </a>
            </div>
        </header>

        <main class="app-content">
            <div class="content-container">
                @Body
            </div>
        </main>
    </div>
</div>


@code {
    protected override void OnInitialized()
    {
        ThemeService.OnChanged += HandleThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitAsync();
            StateHasChanged(); // Re-render with correct theme state
        }
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleAsync();
    }

    private void HandleThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.OnChanged -= HandleThemeChanged;
    }
}

